<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.dingdaoyi.mapper.DeviceMapper">
    <resultMap id="BaseResultMap" type="com.github.dingdaoyi.entity.Device">
        <!--@mbg.generated-->
        <!--@Table tb_device-->
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="device_name" property="deviceName"/>
        <result column="device_key" property="deviceKey"/>
        <result column="device_secret" property="deviceSecret"/>
        <result column="online" property="online"/>
        <result column="active_status" property="activeStatus"/>
    </resultMap>
    <resultMap id="DTOResultMap" extends="BaseResultMap" type="com.github.dingdaoyi.model.DTO.DeviceDTO">
        <result column="proto_key" property="protoKey"/>
        <result column="product_key" property="productKey"/>
    </resultMap>

    <resultMap id="PageVoResultMap" extends="BaseResultMap" type="com.github.dingdaoyi.model.vo.DevicePageVo">
        <result column="product_type_name" property="productTypeName"/>
        <result column="product_model" property="productModel"/>
        <result column="manufacturer" property="manufacturer"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--@mbg.generated-->
        id,
        product_id,
        device_name,
        device_key,
        device_secret,
        online,
        active_status
    </sql>
    <sql id="dvs_column_list">
        dvs.id,
        dvs.product_id,
        dvs.device_name,
        dvs.device_key,
        dvs.device_secret,
        dvs.online,
        dvs.active_status
    </sql>

    <select id="findByDeviceKey" resultMap="DTOResultMap">
        select
        <include refid="dvs_column_list"/>,
                                              proto.proto_key,
                                              prod.product_key as product_key
    from tb_device dvs
             left join tb_product prod on prod.id = dvs.product_id
             left join tb_protocol proto on proto.id = prod.protocol_id
    where dvs.device_key = #{deviceKey}
    </select>

    <select id="pageByQuery" resultMap="PageVoResultMap">
        select
        <include refid="dvs_column_list"/>,
        pt.name as product_type_name,
        pt.id as productTypeId,
        pd.model as product_model,
        pd.manufacturer as manufacturer
        from tb_device dvs
                 left join tb_product pd on pd.id = dvs.product_id
                 left join tb_product_type pt on pd.product_type_id = pt.id
        <where>
            <if test="query.productTypeId != null">
                pt.id=#{query.productTypeId}
            </if>
            <if test="query.productId != null">
                and pd.id =#{query.productId}
            </if>
            <if test="query.manufacturer != null and query.manufacturer != ''">
                and pd.manufacturer =#{query.manufacturer}
            </if>
            <if test="query.deviceKey != null and query.deviceKey != ''">
                and dvs.device_key like CONCAT('%', #{query.deviceKey}::text, '%')
            </if>
            <if test="query.parentId != null">
                and dvs.parentid = #{query.parentId}
            </if>
        </where>
    </select>

<!--auto generated by MybatisCodeHelper on 2024-12-23-->
    <select id="findDeviceKeyById" resultType="java.lang.String">
        select device_key
        from tb_device
        where id=#{id}
    </select>

    <select id="listByProductAndDeviceKey" resultMap="BaseResultMap">
        select <include refid="dvs_column_list"/>
        from tb_device dvs
        join tb_product prd on prd.id=dvs.product_id
        join tb_product_type tp on tp.id= prd.product_type_id
        <where>
            <if test="productTypeId != null">
                tp.id =#{productTypeId}
            </if>
            <if test="productId != null">
                and prd.id= #{productId}
            </if>
            <if test="deviceKey != null and deviceKey != ''">
                and dvs.device_key like CONCAT('%', #{deviceKey}::text, '%')
            </if>
        </where>
    </select>

    <select id="selectByThirdDeviceId" resultMap="DTOResultMap">
        select
        <include refid="dvs_column_list"/>,
                                              proto.proto_key,
                                              prod.product_key as product_key
    from tb_device dvs
             left join tb_product prod on prod.id = dvs.product_id
             left join tb_protocol proto on proto.id = prod.protocol_id
    where dvs.third_device_id = #{thirdDeviceId}
    </select>
</mapper>